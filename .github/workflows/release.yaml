name: Release from Develop via Release Branch

on:
  push:
    branches:
      - develop

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read last commit message
        id: commit
        run: echo "COMMIT_MSG=$(git log -1 --pretty=%B)" >> $GITHUB_ENV

      - name: Detect release version
        id: version
        run: |
          echo "Commit message: $COMMIT_MSG"
          if [[ "$COMMIT_MSG" =~ ^/release-([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "Release detected: ${BASH_REMATCH[1]}"
          else
            echo "No release tag found. Skipping release workflow."
            exit 0
          fi

      - name: Configure Git
        if: steps.version.outputs.version
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Create release branch
        if: steps.version.outputs.version
        run: git checkout -b release/${{ steps.version.outputs.version }}

      - name: Update package.json version
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          jq --arg v "$ver" '.version = $v' package.json > tmp.json
          mv tmp.json package.json
          git add package.json
          git commit -m "Update version to $ver"

      - name: Push release branch to main
        if: steps.version.outputs.version
        run: git push origin release/${{ steps.version.outputs.version }}:main

      - name: Create tag on main
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          git checkout main
          git tag v$ver
          git push origin v$ver

      - name: Merge main back into develop
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          git checkout develop
          git pull origin develop
          git merge main --no-ff -m "Merge release $ver from main"
          git push origin develop

      - name: Delete release branch
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          git branch -d release/$ver || true
          git push origin --delete release/$ver || true
