name: Release from Develop via Release Branch

on:
  push:
    branches:
      - develop

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read last commit message
        id: commit
        run: echo "COMMIT_MSG=$(git log -1 --pretty=%B)" >> $GITHUB_ENV

      - name: Detect release version
        id: version
        run: |
          echo "Commit message: $COMMIT_MSG"
          if [[ "$COMMIT_MSG" =~ /?release-([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "Release detected: $VERSION"
          else
            echo "No release tag found. Skipping release workflow."
            exit 0
          fi

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Create release branch
        run: git checkout -b release/$VERSION

      - name: Update package.json version
        run: |
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json
          mv tmp.json package.json
          git add package.json
          git commit -m "Update version to $VERSION"

      - name: Push release branch to main
        run: |
          git checkout release/$VERSION
          git push origin release/$VERSION:main

      - name: Create tag on main
        run: |
          git checkout main
          git tag $VERSION
          git push origin $VERSION

      - name: Merge main back into develop
        run: |
          git checkout develop
          git pull origin develop
          git merge main --no-ff -m "Merge release $VERSION from main"
          git push origin develop

      - name: Delete release branch
        run: |
          git branch -d release/$VERSION || true
          git push origin --delete release/$VERSION || true
