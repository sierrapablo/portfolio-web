name: Safe Release from Develop

on:
  push:
    branches:
      - develop

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read last commit message
        id: commit
        run: echo "COMMIT_MSG=$(git log -1 --pretty=%B)" >> $GITHUB_ENV

      - name: Detect release version
        id: version
        run: |
          echo "Commit message: $COMMIT_MSG"
          if [[ "$COMMIT_MSG" =~ ^/release-([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "Release detected: ${BASH_REMATCH[1]}"
          else
            echo "No release tag found. Skipping release workflow."
            exit 0
          fi

      - name: Configure Git
        if: steps.version.outputs.version
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Create release branch
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          git checkout -b release/$ver
          git push origin release/$ver

      - name: Update package.json version
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          jq --arg v "$ver" '.version = $v' package.json > tmp.json
          mv tmp.json package.json
          git add package.json
          git commit -m "Update version to $ver"
          git push origin release/$ver

      - name: Merge release branch into main
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          git fetch origin main
          git checkout main
          git pull origin main
          git merge release/$ver --no-ff -m "Release $ver from release branch"
          git push origin main

      - name: Create tag on main
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          git tag $ver
          git push origin $ver

      - name: Merge main back into develop
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          git checkout develop
          git pull origin develop
          git merge main --no-ff -m "Sync release $ver from main"
          git push origin develop

      - name: Delete release branch
        if: steps.version.outputs.version
        run: |
          ver=${{ steps.version.outputs.version }}
          git branch -d release/$ver || true
          git push origin --delete release/$ver || true

      - name: Create GitHub Release
        if: steps.version.outputs.version
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: |
            Automatic release from main branch via release branch.
            Version: ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
